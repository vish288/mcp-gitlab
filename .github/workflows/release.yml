name: Semantic Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: "Dry run (no tag/push)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Get current version
        id: current
        run: |
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Current version: $version"

      - name: Compute next version
        id: next
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.current.outputs.version }}"
          case "${{ inputs.bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          version="$major.$minor.$patch"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Next version: $version"

      - name: Update pyproject.toml version
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.next.outputs.version }}\"/" pyproject.toml
          cat pyproject.toml | grep '^version'

      - name: Verify build
        run: uv build

      - name: Create release commit and tag via API
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_VERSION: ${{ steps.next.outputs.version }}
        run: |
          # Get the updated file content as base64
          CONTENT=$(base64 -w 0 pyproject.toml)
          MAIN_SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/main --jq '.object.sha')

          # Create a blob for the updated pyproject.toml
          BLOB_SHA=$(gh api repos/${{ github.repository }}/git/blobs \
            -X POST \
            -f encoding=base64 \
            -f content="$CONTENT" \
            --jq '.sha')

          # Get the tree of the current commit
          BASE_TREE=$(gh api repos/${{ github.repository }}/git/commits/$MAIN_SHA --jq '.tree.sha')

          # Create a new tree with the updated file
          NEW_TREE=$(gh api repos/${{ github.repository }}/git/trees \
            -X POST \
            --input - <<EOF | jq -r '.sha'
          {
            "base_tree": "$BASE_TREE",
            "tree": [
              {
                "path": "pyproject.toml",
                "mode": "100644",
                "type": "blob",
                "sha": "$BLOB_SHA"
              }
            ]
          }
          EOF
          )

          # Create the commit
          COMMIT_SHA=$(gh api repos/${{ github.repository }}/git/commits \
            -X POST \
            --input - <<EOF | jq -r '.sha'
          {
            "message": "chore(release): $NEXT_VERSION",
            "tree": "$NEW_TREE",
            "parents": ["$MAIN_SHA"],
            "author": {
              "name": "github-actions[bot]",
              "email": "github-actions[bot]@users.noreply.github.com"
            }
          }
          EOF
          )

          # Update main to point to the new commit
          gh api repos/${{ github.repository }}/git/refs/heads/main \
            -X PATCH \
            -f sha="$COMMIT_SHA" \
            -F force=false

          # Create the tag reference
          gh api repos/${{ github.repository }}/git/refs \
            -X POST \
            -f ref="refs/tags/v$NEXT_VERSION" \
            -f sha="$COMMIT_SHA"

          echo "Created commit $COMMIT_SHA and tag v$NEXT_VERSION"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "## Dry Run Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Current: ${{ steps.current.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Next: ${{ steps.next.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Bump: ${{ inputs.bump }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- No changes pushed." >> "$GITHUB_STEP_SUMMARY"

      - name: Release summary
        if: ${{ !inputs.dry_run }}
        run: |
          echo "## Release v${{ steps.next.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tag pushed. Publish workflow will deploy to PyPI." >> "$GITHUB_STEP_SUMMARY"
