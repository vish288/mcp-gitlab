name: Semantic Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (ignored if version is set)"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: "Explicit version (e.g. 0.7.0) â€” overrides bump"
        required: false
        type: string
        default: ""
      dry_run:
        description: "Dry run (no tag/push)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Get current version
        id: current
        run: |
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Current version: $version"

      - name: Compute next version
        id: next
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            version="${{ inputs.version }}"
            echo "Explicit version: $version"
          else
            IFS='.' read -r major minor patch <<< "${{ steps.current.outputs.version }}"
            case "${{ inputs.bump }}" in
              major) major=$((major + 1)); minor=0; patch=0 ;;
              minor) minor=$((minor + 1)); patch=0 ;;
              patch) patch=$((patch + 1)) ;;
            esac
            version="$major.$minor.$patch"
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Next version: $version"

      - name: Update pyproject.toml version
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.next.outputs.version }}\"/" pyproject.toml
          cat pyproject.toml | grep '^version'

      - name: Regenerate uv.lock
        run: uv lock

      - name: Generate CHANGELOG.md
        id: changelog
        env:
          NEXT_VERSION: ${{ steps.next.outputs.version }}
        run: |
          # Find previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          DATE=$(date -u +%Y-%m-%d)
          ENTRY="## [${NEXT_VERSION}] - ${DATE}"$'\n'

          # Collect commits grouped by type
          for type_label in "feat:Features" "fix:Bug Fixes" "refactor:Refactoring" "docs:Documentation" "perf:Performance" "test:Tests" "chore:Chores"; do
            type="${type_label%%:*}"
            label="${type_label#*:}"
            commits=$(git log "$RANGE" --pretty=format:"- %s (%h)" --grep="^${type}" 2>/dev/null || true)
            if [ -n "$commits" ]; then
              ENTRY+=$'\n'"### ${label}"$'\n'
              ENTRY+="${commits}"$'\n'
            fi
          done

          # Collect commits that don't match any conventional type
          other=$(git log "$RANGE" --pretty=format:"%s|%h" 2>/dev/null | \
            grep -v -E "^(feat|fix|refactor|docs|perf|test|chore)(\(.*\))?:" || true)
          if [ -n "$other" ]; then
            ENTRY+=$'\n'"### Other"$'\n'
            echo "$other" | while IFS='|' read -r msg hash; do
              ENTRY+="- ${msg} (${hash})"$'\n'
            done
          fi

          # Prepend to existing CHANGELOG.md or create new
          if [ -f CHANGELOG.md ]; then
            # Insert new entry after the first line (# Changelog header)
            {
              head -1 CHANGELOG.md
              echo ""
              echo "$ENTRY"
              tail -n +2 CHANGELOG.md
            } > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
          else
            {
              echo "# Changelog"
              echo ""
              echo "$ENTRY"
            } > CHANGELOG.md
          fi

          # Save entry for summary display
          echo "$ENTRY" > /tmp/changelog-entry.txt
          echo "Generated CHANGELOG.md entry for v${NEXT_VERSION}"

      - name: Verify build
        run: uv build

      - name: Create release commit and tag via API
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
          NEXT_VERSION: ${{ steps.next.outputs.version }}
        run: |
          MAIN_SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/main --jq '.object.sha')
          BASE_TREE=$(gh api repos/${{ github.repository }}/git/commits/$MAIN_SHA --jq '.tree.sha')

          # Create blobs for all modified files (use temp files to avoid ARG_MAX limits on large files)
          create_blob() {
            local file="$1"
            base64 -w 0 "$file" > /tmp/b64content.txt
            jq -Rs '{"encoding":"base64","content":rtrimstr("\n")}' /tmp/b64content.txt > /tmp/blob.json
            gh api repos/${{ github.repository }}/git/blobs \
              -X POST --input /tmp/blob.json --jq '.sha'
          }

          PYPROJECT_BLOB=$(create_blob pyproject.toml)
          UVLOCK_BLOB=$(create_blob uv.lock)
          CHANGELOG_BLOB=$(create_blob CHANGELOG.md)

          # Create tree with all 3 files
          NEW_TREE=$(gh api repos/${{ github.repository }}/git/trees \
            -X POST \
            --input - <<EOF | jq -r '.sha'
          {
            "base_tree": "$BASE_TREE",
            "tree": [
              {
                "path": "pyproject.toml",
                "mode": "100644",
                "type": "blob",
                "sha": "$PYPROJECT_BLOB"
              },
              {
                "path": "uv.lock",
                "mode": "100644",
                "type": "blob",
                "sha": "$UVLOCK_BLOB"
              },
              {
                "path": "CHANGELOG.md",
                "mode": "100644",
                "type": "blob",
                "sha": "$CHANGELOG_BLOB"
              }
            ]
          }
          EOF
          )

          # Create the commit
          COMMIT_SHA=$(gh api repos/${{ github.repository }}/git/commits \
            -X POST \
            --input - <<EOF | jq -r '.sha'
          {
            "message": "chore(release): $NEXT_VERSION",
            "tree": "$NEW_TREE",
            "parents": ["$MAIN_SHA"],
            "author": {
              "name": "github-actions[bot]",
              "email": "github-actions[bot]@users.noreply.github.com"
            }
          }
          EOF
          )

          # Update main to point to the new commit
          gh api repos/${{ github.repository }}/git/refs/heads/main \
            -X PATCH \
            -f sha="$COMMIT_SHA" \
            -F force=false

          # Create the tag reference
          gh api repos/${{ github.repository }}/git/refs \
            -X POST \
            -f ref="refs/tags/v$NEXT_VERSION" \
            -f sha="$COMMIT_SHA"

          echo "Created commit $COMMIT_SHA and tag v$NEXT_VERSION"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "## Dry Run Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Current: ${{ steps.current.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Next: ${{ steps.next.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Bump: ${{ inputs.bump }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- No changes pushed." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Changelog Preview" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/changelog-entry.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Release summary
        if: ${{ !inputs.dry_run }}
        run: |
          echo "## Release v${{ steps.next.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tag pushed. Publish workflow will deploy to PyPI." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Changelog Entry" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/changelog-entry.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
